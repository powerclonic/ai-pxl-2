<!DOCTYPE html>
<html>

<head>
    <title>Pixel Place - Collaborative Canvas</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/css/styles.css">
    <!-- Material Symbols Icon Font -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />
</head>

<body>
    <!-- Authentication Modal -->
    <div class="auth-modal" id="authModal">
        <div class="auth-modal-content">
            <div class="auth-header">
                <h2>Pixel Canvas - Login Required</h2>
                <p>Please sign in to start placing pixels</p>
            </div>
            
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="showLoginForm()">Login</button>
                <button class="auth-tab" onclick="showRegisterForm()">Register</button>
            </div>
            
            <!-- Login Form -->
            <div class="auth-form" id="loginForm">
                <form id="loginFormElement">
                    <div class="form-group">
                        <label for="loginUsername">Username:</label>
                        <input type="text" id="loginUsername" name="username" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password:</label>
                        <input type="password" id="loginPassword" name="password" required>
                    </div>
                    <div class="form-group captcha-group" id="loginCaptchaGroup" style="display: none;">
                        <label for="loginCaptcha">Security Check:</label>
                        <div class="captcha-question" id="loginCaptchaQuestion"></div>
                        <input type="text" id="loginCaptcha" name="captcha_answer" placeholder="Enter answer">
                    </div>
                    <button type="submit" class="auth-submit">Login</button>
                </form>
            </div>
            
            <!-- Register Form -->
            <div class="auth-form" id="registerForm" style="display: none;">
                <form id="registerFormElement">
                    <div class="form-group">
                        <label for="registerUsername">Username:</label>
                        <input type="text" id="registerUsername" name="username" required>
                        <small>3-20 characters</small>
                    </div>
                    <div class="form-group">
                        <label for="registerPassword">Password:</label>
                        <input type="password" id="registerPassword" name="password" required>
                        <small>Minimum 6 characters</small>
                    </div>
                    <div class="form-group">
                        <label for="registerConfirmPassword">Confirm Password:</label>
                        <input type="password" id="registerConfirmPassword" name="confirmPassword" required>
                    </div>
                    <button type="submit" class="auth-submit">Register</button>
                </form>
            </div>
            
            <div class="auth-error" id="authError"></div>
            <div class="auth-loading" id="authLoading" style="display: none;">
                <div class="loading-spinner"></div>
                <span>Connecting...</span>
            </div>
        </div>
    </div>

        <div class="main-container" id="mainContainer" style="display: none;">
        <!-- Floating Action Cluster (replaces top navbar) -->
        <div class="floating-actions" id="floatingActions">
            <div class="fab-stack">
                <button class="fab" onclick="zoomToCenter()" title="Center" aria-label="Center"><span class="material-symbols-rounded">center_focus_strong</span></button>
                <button class="fab" onclick="openProfile()" title="Profile" aria-label="Profile"><span class="material-symbols-rounded">person</span></button>
                <button class="fab" onclick="openRankings()" title="Rankings" aria-label="Rankings"><span class="material-symbols-rounded">emoji_events</span></button>
                <button class="fab" onclick="showTutorial()" title="Help" aria-label="Help"><span class="material-symbols-rounded">help</span></button>
                <button class="fab admin-only" id="adminNavBtn" style="display:none;" onclick="openAdminPanel()" title="Admin" aria-label="Admin"><span class="material-symbols-rounded">build</span></button>
                <button class="fab danger" onclick="logout()" title="Logout" aria-label="Logout"><span class="material-symbols-rounded">power_settings_new</span></button>
            </div>
        </div>

        <div class="canvas-container">
            <div class="canvas-wrapper" id="canvasWrapper">
                <canvas id="pixelCanvas" width="800" height="600"></canvas>
                <div class="pixel-preview" id="pixelPreview"></div>
            </div>

            <!-- Pixel Info Tooltip -->
            <div class="pixel-info-tooltip" id="pixelInfoTooltip">
                <div class="pixel-info-content">
                    <div class="pixel-info-user">User: <span id="pixelUser">-</span></div>
                    <div class="pixel-info-time">Placed: <span id="pixelTime">-</span></div>
                </div>
            </div>

            <!-- Position Display -->
            <div class="position-display" id="positionDisplay">
                <div class="position-text">
                    Region: <span id="regionPos">0,0</span> |
                    Pixel: <span id="pixelPos">0,0</span>
                </div>
            </div>
        </div>

        <!-- Floating Minimalist Color Palette -->
        <div class="color-palette-fixed minimized" id="colorPaletteFixed">
            <!-- Toggle Button - Always Visible -->
            <div class="color-palette-toggle" id="colorPaletteToggle" onclick="toggleColorPalette()">
                <span class="palette-icon">üé®</span>
                <span class="palette-text">Loading...</span>
            </div>

            <!-- Drawer Content - Only Visible When Expanded -->
            <div class="color-palette-content" id="colorPaletteContent">
                <div class="pixel-bag-info">
                    <div class="bag-text" id="bagText">Pixels: <span id="pixelCount">0</span></div>
                    <div class="bag-progress">
                        <div class="bag-fill" id="bagFill"></div>
                    </div>
                </div>

                <div class="color-grid" id="colorGrid"></div>
            </div>
        </div>

        <!-- Chat Panel (Rewritten like pixel-bag style) -->
        <div id="chatPanel" class="chat-shell minimized" aria-expanded="false">
            <div class="chat-section chat-header" onclick="toggleChatShell()">
                <div class="chat-title-line">
                    <span class="chat-icon material-symbols-rounded">chat</span>
                    <span class="chat-label">Chat</span>
                    <span id="chatUnreadBadge" class="chat-unread" style="display:none;">0</span>
                </div>
                <span class="chevron material-symbols-rounded" id="chatChevron">expand_less</span>
            </div>
            <div class="chat-section chat-info" id="chatInfoBar">
                <div class="info-items">
                    <span class="info-item" title="Connection"><span id="connectionIndicator" class="status-indicator status-connecting"></span><span id="connectionStatusText">...</span></span>
                    <span class="info-item" title="Ping"><span class="material-symbols-rounded">speed</span><span id="pingDisplay">--ms</span></span>
                    <span class="info-item" title="Users"><span class="material-symbols-rounded">group</span><span id="userCount">0</span></span>
                </div>
            </div>
            <div class="chat-section chat-body" id="chatDrawer">
                <div class="chat-messages" id="chatMessages"></div>
                <div class="chat-input-row">
                    <input id="chatInput" type="text" maxlength="200" placeholder="Type a message..." />
                    <button class="send-btn" onclick="sendChatMessage()"><span class="material-symbols-rounded">send</span></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tutorial Modal -->
    <div class="tutorial-modal glass-readable" id="tutorialModal">
        <div class="tutorial-modal-content">
            <div class="tutorial-header">
                <h2>üé® Welcome to PixelPlace!</h2>
                <button class="tutorial-close" onclick="closeTutorial()">√ó</button>
            </div>
            
            <div class="tutorial-body">
                <div class="tutorial-step active" id="step1">
                    <div class="tutorial-icon">üñ±Ô∏è</div>
                    <h3>Navigate the Canvas</h3>
                    <p>Use your <strong>mouse wheel</strong> to zoom in/out and <strong>drag</strong> to move around the infinite canvas.</p>
                </div>
                
                <div class="tutorial-step" id="step2">
                    <div class="tutorial-icon">üé®</div>
                    <h3>Place Pixels</h3>
                    <p>Click the <strong>color palette</strong> at the bottom to choose a color, then click anywhere on the canvas to place a pixel.</p>
                </div>
                
                <div class="tutorial-step" id="step3">
                    <div class="tutorial-icon">‚ö°</div>
                    <h3>Bulk Placement</h3>
                    <p>Hold <strong>Space</strong> and drag to preview multiple pixels, then release to place them all at once!</p>
                </div>
                
                <div class="tutorial-step" id="step4">
                    <div class="tutorial-icon">üí¨</div>
                    <h3>Chat & Community</h3>
                    <p>Use the chat panel to communicate with other artists. Work together to create amazing pixel art!</p>
                </div>
                
                <div class="tutorial-step" id="step5">
                    <div class="tutorial-icon">‚è±Ô∏è</div>
                    <h3>Pixel Bag System</h3>
                    <p>You have a limited number of pixels that refill over time. Use them wisely to create your masterpiece!</p>
                </div>
            </div>
            
            <div class="tutorial-footer">
                <button class="tutorial-nav-btn" id="prevBtn" onclick="previousStep()" disabled>Previous</button>
                <div class="tutorial-dots">
                    <span class="dot active" onclick="goToStep(1)"></span>
                    <span class="dot" onclick="goToStep(2)"></span>
                    <span class="dot" onclick="goToStep(3)"></span>
                    <span class="dot" onclick="goToStep(4)"></span>
                    <span class="dot" onclick="goToStep(5)"></span>
                </div>
                <button class="tutorial-nav-btn" id="nextBtn" onclick="nextStep()">Next</button>
            </div>
            
            <div class="tutorial-bottom">
                <label class="tutorial-checkbox">
                    <input type="checkbox" id="dontShowAgain"> Don't show this again
                </label>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="profile-modal glass-readable" id="profileModal">
        <div class="profile-modal-content">
            <div class="profile-header">
                <h2><span class="material-symbols-rounded icon-inline">person</span> Player Profile</h2>
                <button class="profile-close" onclick="closeProfile()">√ó</button>
            </div>
            
            <div class="profile-body">
                <div class="profile-card">
                    <div class="profile-avatar">
                        <span class="avatar-emoji" id="profileAvatar">üé®</span>
                    </div>
                    <div class="profile-info">
                        <h3 id="profileUsername">Loading...</h3>
                        <div class="profile-level">
                            <span class="level-badge" id="profileLevel">Level 1</span>
                        </div>
                    </div>
                </div>
                
                <div class="profile-stats">
                    <div class="stat-card pixels-placed">
                        <div class="stat-icon">üéØ</div>
                        <div class="stat-info">
                            <div class="stat-number" id="statPixelsPlaced">0</div>
                            <div class="stat-label">Pixels Placed</div>
                        </div>
                    </div>
                    
                    <div class="stat-card time-active">
                        <div class="stat-icon">‚è∞</div>
                        <div class="stat-info">
                            <div class="stat-number" id="statTimeActive">0h</div>
                            <div class="stat-label">Time Active</div>
                        </div>
                    </div>
                    
                    <div class="stat-card pixel-bag">
                        <div class="stat-icon">üí∞</div>
                        <div class="stat-info">
                            <div class="stat-number" id="statPixelBag">0/0</div>
                            <div class="stat-label">Pixel Bag</div>
                        </div>
                    </div>
                    
                    <div class="stat-card join-date">
                        <div class="stat-icon">üìÖ</div>
                        <div class="stat-info">
                            <div class="stat-number" id="statJoinDate">Today</div>
                            <div class="stat-label">Joined</div>
                        </div>
                    </div>
                </div>
                
                <div class="profile-achievements">
                    <h4>üèÜ Achievements</h4>
                    <div class="achievements-grid" id="achievementsGrid"><!-- populated dynamically --></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Achievement Toasts -->
    <div id="achievementToasts" style="position:fixed; top:20px; right:20px; z-index:12000; display:flex; flex-direction:column; gap:12px; pointer-events:none;"></div>

    <!-- Rankings Modal -->
    <div class="rankings-modal glass-readable" id="rankingsModal">
        <div class="rankings-content">
            <div class="rankings-header">
                <h2><span class="material-symbols-rounded icon-inline">emoji_events</span> Global Rankings</h2>
                <button class="rankings-close" onclick="closeRankings()">√ó</button>
            </div>
            <div class="rankings-tabs">
                <button class="ranking-tab active" data-type="pixels" onclick="switchRankingTab(this,'pixels')">Pixels</button>
                <button class="ranking-tab" data-type="messages" onclick="switchRankingTab(this,'messages')">Messages</button>
                <button class="ranking-tab" data-type="level" onclick="switchRankingTab(this,'level')">Level</button>
                <button class="ranking-tab" data-type="achievements" onclick="switchRankingTab(this,'achievements')">Achievements</button>
            </div>
            <div class="rankings-table-wrapper">
                <table class="rankings-table" id="rankingsTable">
                    <thead>
                        <tr>
                            <th>Rank</th><th>User</th><th id="metricHeader">Pixels</th><th>Lvl</th><th>Achv</th>
                        </tr>
                    </thead>
                    <tbody id="rankingsBody"><tr><td colspan="5" style="text-align:center; opacity:.7;">Loading...</td></tr></tbody>
                </table>
            </div>
            <div class="rankings-footer">
                <span class="footnote" id="rankingFootnote"></span>
            </div>
        </div>
    </div>

    <!-- Admin Panel (Refactored) -->
    <div id="adminModal" class="admin-overlay" style="display:none;">
        <div class="floating-panel admin-panel" role="dialog" aria-modal="true" aria-labelledby="adminPanelTitle">
            <div class="panel-header admin-panel-header">
                <div class="panel-title" id="adminPanelTitle"><span class="material-symbols-rounded icon-inline">build</span> Administration</div>
                <div class="admin-header-actions">
                    <button class="btn btn-icon" onclick="closeAdminPanel()" title="Close" style="padding:8px 10px; min-width:auto;">
                        <span class="material-symbols-rounded">close</span>
                    </button>
                </div>
            </div>
            <div class="admin-body">
                <div class="admin-nav" role="tablist">
                    <button class="admin-tab active" data-target="usersTab" onclick="switchAdminSection(this)"><span class="material-symbols-rounded">group</span><span>Users</span></button>
                    <button class="admin-tab" data-target="statsTab" onclick="switchAdminSection(this)"><span class="material-symbols-rounded">analytics</span><span>Stats</span></button>
                    <button class="admin-tab" data-target="achievementsAdminTab" onclick="switchAdminSection(this)"><span class="material-symbols-rounded">emoji_events</span><span>Achievements</span></button>
                </div>
                <div class="admin-sections">
                    <!-- Users -->
                    <section id="usersTab" class="admin-section active" aria-label="Users Management">
                        <div class="section-toolbar">
                            <div class="toolbar-left">
                                <button class="btn" onclick="refreshUsers()"><span class="material-symbols-rounded">refresh</span>Refresh</button>
                                <div class="input-wrapper">
                                    <span class="material-symbols-rounded">search</span>
                                    <input type="text" id="userSearchInput" placeholder="Search users..." onkeyup="filterUsers()" />
                                </div>
                            </div>
                            <div class="toolbar-right" id="usersMeta"></div>
                        </div>
                        <div class="users-list" id="usersList"><div class="loading">Loading users...</div></div>
                        <div class="inline-hint" id="usersHint" style="display:none;">No users found.</div>
                    </section>
                    <!-- Stats -->
                    <section id="statsTab" class="admin-section" aria-label="Platform Stats">
                        <div class="stats-grid" id="statsGrid">
                            <div class="stat-card"><h3>Total Users</h3><div class="stat-value" id="totalUsers">-</div></div>
                            <div class="stat-card"><h3>Active Users</h3><div class="stat-value" id="activeUsers">-</div></div>
                            <div class="stat-card"><h3>Banned Users</h3><div class="stat-value" id="bannedUsers">-</div></div>
                            <div class="stat-card"><h3>Total Pixels Placed</h3><div class="stat-value" id="totalPixels">-</div></div>
                        </div>
                    </section>
                    <!-- Achievements -->
                    <section id="achievementsAdminTab" class="admin-section" aria-label="Achievement Definitions">
                        <div class="section-toolbar">
                            <div class="toolbar-left">
                                <button class="btn" onclick="refreshAchievementDefs()"><span class="material-symbols-rounded">refresh</span>Refresh</button>
                                <button class="btn" onclick="openNewAchievementForm()"><span class="material-symbols-rounded">add</span>New</button>
                                <button class="btn" onclick="exportAchievementDefs()"><span class="material-symbols-rounded">download</span>Export</button>
                                <label class="btn import-label" title="Import JSON"> <span class="material-symbols-rounded">upload</span>Import<input type="file" accept="application/json" onchange="importAchievementDefs(event)" hidden></label>
                            </div>
                            <div class="toolbar-right" id="achDefsMeta"></div>
                        </div>
                        <div id="achievementDefsList" class="ach-defs-list"></div>
                        <div id="achievementEditor" class="ach-editor" style="display:none;">
                            <h3 id="achEditorTitle">New Achievement</h3>
                            <div class="form-grid">
                                <label>ID<input id="achId" type="text" placeholder="unique_id"></label>
                                <label>Icon<input id="achIcon" type="text" placeholder="e.g. star" maxlength="32"></label>
                                <label>Name<input id="achName" type="text" placeholder="Visible name"></label>
                                <label>Tier
                                    <select id="achTier">
                                        <option value="">(none)</option>
                                        <option value="easy">Easy</option>
                                        <option value="normal">Normal</option>
                                        <option value="hard">Hard</option>
                                        <option value="epic">Epic</option>
                                        <option value="legendary">Legendary</option>
                                    </select>
                                </label>
                                <label>Desc<textarea id="achDesc" rows="2" placeholder="Description"></textarea></label>
                                <label>Condition<select id="achCondType"><option value="pixels">pixels</option><option value="bulk_uses">bulk_uses</option><option value="chat_messages">chat_messages</option><option value="session_minutes">session_minutes</option></select></label>
                                <label>Value<input id="achCondValue" type="number" min="1" value="1"></label>
                            </div>
                            <div class="ach-editor-actions">
                                <button class="btn btn-primary" onclick="saveAchievementDef()">Save</button>
                                <button class="btn" onclick="closeAchievementEditor()">Cancel</button>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </div>
        <!-- Ban Modal (global overlay inside admin) -->
        <div class="ban-modal" id="banModal" style="display:none;">
            <div class="ban-modal-content">
                <h3>Ban User</h3>
                <form id="banForm" onsubmit="handleBanUser(event)">
                    <input type="hidden" id="banUsername" name="banUsername">
                    <div class="form-group">
                        <label>Reason:</label>
                        <input type="text" id="banReason" name="banReason" placeholder="Reason for ban" required>
                    </div>
                    <div class="form-group">
                        <label><input type="checkbox" id="banTemporary" name="banTemporary"> Temporary ban (24h)</label>
                    </div>
                    <div class="ban-actions">
                        <button type="submit" class="btn btn-danger">Ban User</button>
                        <button type="button" onclick="closeBanModal()" class="btn">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="/static/js/app.js"></script>
</body>

</html>