<!DOCTYPE html>
<html>

<head>
    <title>Pixel Place - Collaborative Canvas</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/css/styles.css">
    <!-- Material Symbols Icon Font -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />
</head>

<body>
    <!-- Authentication Modal (Restyled) -->
    <div class="auth-modal" id="authModal">
        <div class="auth-shell">
            <div class="auth-left">
                <div class="brand-badge">
                    <span class="material-symbols-rounded logo-ico">palette</span>
                </div>
                <h1 class="auth-title">
                    <span class="grad-text">PixelPlace</span>
                    <small>Colabore, conquiste, evolua.</small>
                </h1>
                <ul class="auth-features">
                    <li><span class="material-symbols-rounded">draw</span> Canvas colaborativo infinito</li>
                    <li><span class="material-symbols-rounded">auto_awesome</span> Cores raras & efeitos especiais</li>
                    <li><span class="material-symbols-rounded">inventory_2</span> Loot boxes & economia</li>
                    <li><span class="material-symbols-rounded">emoji_events</span> Achievements & níveis</li>
                    <li><span class="material-symbols-rounded">chat</span> Chat em tempo real</li>
                </ul>
                <div class="auth-mini-tip">Sem fundo pesado • Interface glass • Rápido e leve</div>
            </div>
            <div class="auth-card">
                <div class="auth-header">
                    <h2 class="switchable" id="authCardTitle">Entre ou crie sua conta</h2>
                </div>
                <div class="auth-tabs pill" role="tablist">
                    <button class="auth-tab active" onclick="showLoginForm()" id="loginTab" aria-controls="loginForm" aria-selected="true">Login</button>
                    <button class="auth-tab" onclick="showRegisterForm()" id="registerTab" aria-controls="registerForm" aria-selected="false">Registrar</button>
                </div>
                <!-- Login Form -->
                <div class="auth-form" id="loginForm">
                    <form id="loginFormElement" autocomplete="on">
                        <div class="form-row">
                            <label for="loginUsername">Usuário</label>
                            <input type="text" id="loginUsername" name="username" minlength="3" maxlength="20" required placeholder="Seu nick" autocomplete="username">
                        </div>
                        <div class="form-row">
                            <label for="loginPassword">Senha</label>
                            <input type="password" id="loginPassword" name="password" required placeholder="••••••" autocomplete="current-password">
                        </div>
                        <div class="form-row captcha compact" id="loginCaptchaGroup" style="display:none;">
                            <div class="captcha-head">
                                <label for="loginCaptcha" class="captcha-label">Verificação</label>
                                <span class="captcha-question" id="loginCaptchaQuestion"></span>
                            </div>
                            <input type="text" id="loginCaptcha" name="captcha_answer" placeholder="Resposta" autocomplete="off">
                        </div>
                        <button type="submit" class="btn-auth primary">Entrar<span class="material-symbols-rounded">login</span></button>
                    </form>
                </div>
                <!-- Register Form -->
                <div class="auth-form" id="registerForm" style="display:none;">
                    <form id="registerFormElement" autocomplete="off">
                        <div class="form-row">
                            <label for="registerUsername">Usuário</label>
                            <input type="text" id="registerUsername" name="username" minlength="3" maxlength="20" required placeholder="Novo nick">
                            <small>3–20 caracteres</small>
                        </div>
                        <div class="form-row">
                            <label for="registerPassword">Senha</label>
                            <input type="password" id="registerPassword" name="password" minlength="6" required placeholder="Crie uma senha" autocomplete="new-password">
                            <small>Mínimo 6 caracteres</small>
                        </div>
                        <div class="form-row">
                            <label for="registerConfirmPassword">Confirmar</label>
                            <input type="password" id="registerConfirmPassword" name="confirmPassword" required placeholder="Repita a senha" autocomplete="new-password">
                        </div>
                        <button type="submit" class="btn-auth gradient">Registrar<span class="material-symbols-rounded">person_add</span></button>
                    </form>
                </div>
                <div class="auth-error" id="authError"></div>
                <div class="auth-loading" id="authLoading" style="display:none;">
                    <div class="loading-spinner"></div>
                    <span>Conectando...</span>
                </div>
                <div class="auth-foot-note">
                    <span class="foot-mini">Ao continuar você concorda com as regras da comunidade.</span>
                </div>
            </div>
        </div>
    </div>

        <div class="main-container" id="mainContainer" style="display: none;">
        <!-- Floating Action Cluster (replaces top navbar) -->
        <div class="floating-actions" id="floatingActions">
            <div class="fab-stack">
                <button class="fab" onclick="zoomToCenter()" title="Center" aria-label="Center"><span class="material-symbols-rounded">center_focus_strong</span></button>
                <button class="fab" onclick="openProfile()" title="Profile" aria-label="Profile"><span class="material-symbols-rounded">person</span></button>
                <button class="fab" onclick="openRankings()" title="Rankings" aria-label="Rankings"><span class="material-symbols-rounded">emoji_events</span></button>
                <button class="fab" onclick="openLootBoxesModal()" title="Loot Boxes" aria-label="Loot Boxes"><span class="material-symbols-rounded">inventory_2</span></button>
                <button class="fab" onclick="showTutorial()" title="Help" aria-label="Help"><span class="material-symbols-rounded">help</span></button>
                <button class="fab admin-only" id="adminNavBtn" style="display:none;" onclick="openAdminPanel()" title="Admin" aria-label="Admin"><span class="material-symbols-rounded">build</span></button>
                <button class="fab danger" onclick="logout()" title="Logout" aria-label="Logout"><span class="material-symbols-rounded">power_settings_new</span></button>
            </div>
            <!-- Compact Economy Sidebar -->
            <div class="economy-sidebar" id="economySidebar">
                <div class="eco-line" title="Coins">
                    <span class="material-symbols-rounded eco-ico">paid</span>
                    <span id="coinBalance">0</span>
                </div>
                <div class="eco-line level" title="Level Progress">
                    <span id="levelBadge" class="level-chip">Lv.1</span>
                    <div class="xp-mini-bar"><div id="xpFill" class="xp-fill"></div></div>
                    <span id="xpText" class="xp-mini-text">0/0</span>
                </div>
            </div>
        </div>

        <div class="canvas-container">
            <div class="canvas-wrapper" id="canvasWrapper">
                <canvas id="pixelCanvas" width="800" height="600"></canvas>
                <div class="pixel-preview" id="pixelPreview"></div>
            </div>

            <!-- (Removed centered economy bar) -->

            <!-- Pixel Info Tooltip -->
            <div class="pixel-info-tooltip" id="pixelInfoTooltip">
                <div class="pixel-info-content">
                    <div class="pixel-info-user">User: <span id="pixelUser">-</span></div>
                    <div class="pixel-info-time">Placed: <span id="pixelTime">-</span></div>
                </div>
            </div>

            <!-- Position Display -->
            <div class="position-display" id="positionDisplay">
                <div class="position-text">
                    Region: <span id="regionPos">0,0</span> |
                    Pixel: <span id="pixelPos">0,0</span>
                </div>
            </div>
        </div>

    <!-- (Legacy standalone loot admin panel removed - integrated into main admin overlay) -->

        <!-- Floating Minimalist Color Palette -->
        <div class="color-palette-fixed minimized" id="colorPaletteFixed">
            <!-- Toggle Button - Always Visible -->
            <div class="color-palette-toggle" id="colorPaletteToggle" onclick="toggleColorPalette()">
                <span class="palette-icon">🎨</span>
                <span class="palette-text">Loading...</span>
            </div>

            <!-- Drawer Content - Only Visible When Expanded -->
            <div class="color-palette-content" id="colorPaletteContent">
                <div class="pixel-bag-info">
                    <div class="bag-text" id="bagText">Pixels: <span id="pixelCount">0</span></div>
                    <div class="bag-progress">
                        <div class="bag-fill" id="bagFill"></div>
                    </div>
                    <div class="reward-scale" id="rewardScaleIndicator" title="Current reward scaling">
                        <div class="rs-ring"><div class="rs-fill" id="rsFill"></div></div>
                        <div class="rs-text" id="rsText">100%</div>
                    </div>
                </div>

                <div class="color-grid" id="colorGrid"></div>
            </div>
        </div>

        <!-- Chat Panel (Rewritten like pixel-bag style) -->
        <div id="chatPanel" class="chat-shell minimized" aria-expanded="false">
            <div class="chat-section chat-header" onclick="toggleChatShell()">
                <div class="chat-title-line">
                    <span class="chat-icon material-symbols-rounded">chat</span>
                    <span class="chat-label">Chat</span>
                    <span id="chatUnreadBadge" class="chat-unread" style="display:none;">0</span>
                </div>
                <span class="chevron material-symbols-rounded" id="chatChevron">expand_less</span>
            </div>
            <div class="chat-section chat-info" id="chatInfoBar">
                <div class="info-items">
                    <span class="info-item" title="Connection"><span id="connectionIndicator" class="status-indicator status-connecting"></span><span id="connectionStatusText">...</span></span>
                    <span class="info-item" title="Ping"><span class="material-symbols-rounded">speed</span><span id="pingDisplay">--ms</span></span>
                    <span class="info-item" title="Users"><span class="material-symbols-rounded">group</span><span id="userCount">0</span></span>
                </div>
            </div>
            <div class="chat-section chat-body" id="chatDrawer">
                <div class="chat-messages" id="chatMessages"></div>
                <div class="chat-input-row">
                    <input id="chatInput" type="text" maxlength="200" placeholder="Type a message..." />
                    <button class="send-btn" onclick="sendChatMessage()"><span class="material-symbols-rounded">send</span></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tutorial Modal -->
    <div class="tutorial-modal glass-readable" id="tutorialModal">
        <div class="tutorial-modal-content">
            <div class="tutorial-header">
                <h2>🎨 Welcome to PixelPlace!</h2>
                <button class="tutorial-close" onclick="closeTutorial()">×</button>
            </div>
            
            <div class="tutorial-body">
                <div class="tutorial-step active" id="step1">
                    <div class="tutorial-icon">🖱️</div>
                    <h3>Navigate the Canvas</h3>
                    <p>Use your <strong>mouse wheel</strong> to zoom in/out and <strong>drag</strong> to move around the infinite canvas.</p>
                </div>
                
                <div class="tutorial-step" id="step2">
                    <div class="tutorial-icon">🎨</div>
                    <h3>Place Pixels</h3>
                    <p>Click the <strong>color palette</strong> at the bottom to choose a color, then click anywhere on the canvas to place a pixel.</p>
                </div>
                
                <div class="tutorial-step" id="step3">
                    <div class="tutorial-icon">⚡</div>
                    <h3>Bulk Placement</h3>
                    <p>Hold <strong>Space</strong> and drag to preview multiple pixels, then release to place them all at once!</p>
                </div>
                
                <div class="tutorial-step" id="step4">
                    <div class="tutorial-icon">💬</div>
                    <h3>Chat & Community</h3>
                    <p>Use the chat panel to communicate with other artists. Work together to create amazing pixel art!</p>
                </div>
                
                <div class="tutorial-step" id="step5">
                    <div class="tutorial-icon">⏱️</div>
                    <h3>Pixel Bag System</h3>
                    <p>You have a limited number of pixels that refill over time. Use them wisely to create your masterpiece!</p>
                </div>
                
                <div class="tutorial-step" id="step6">
                    <div class="tutorial-icon">📦</div>
                    <h3>Loot & Coins</h3>
                    <p>Agora você ganha <strong>coins</strong> colocando pixels, mandando mensagens e concluindo achievements. Use o botão <span class="material-symbols-rounded icon-inline" style="font-size:18px; vertical-align:middle;">inventory_2</span> para abrir <strong>loot boxes</strong> com cores raras, efeitos (glow / spark) e upgrades de bag.</p>
                </div>

                <div class="tutorial-step" id="step7">
                    <div class="tutorial-icon">🆙</div>
                    <h3>Levels & XP</h3>
                    <p>XP vem de pixels, chat, loot e achievements. Ao subir de nível você recebe um bônus de coins (10 × nível). A mini barra mostra seu progresso para o próximo nível.</p>
                </div>
            </div>
            
            <div class="tutorial-footer">
                <button class="tutorial-nav-btn" id="prevBtn" onclick="previousStep()" disabled>Previous</button>
                <div class="tutorial-dots">
                    <span class="dot active" onclick="goToStep(1)"></span>
                    <span class="dot" onclick="goToStep(2)"></span>
                    <span class="dot" onclick="goToStep(3)"></span>
                    <span class="dot" onclick="goToStep(4)"></span>
                    <span class="dot" onclick="goToStep(5)"></span>
                    <span class="dot" onclick="goToStep(6)"></span>
                    <span class="dot" onclick="goToStep(7)"></span>
                </div>
                <button class="tutorial-nav-btn" id="nextBtn" onclick="nextStep()">Next</button>
            </div>
            
            <div class="tutorial-bottom">
                <label class="tutorial-checkbox">
                    <input type="checkbox" id="dontShowAgain"> Don't show this again
                </label>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="profile-modal glass-readable" id="profileModal">
        <div class="profile-modal-content">
            <div class="profile-header">
                <h2><span class="material-symbols-rounded icon-inline">person</span> Player Profile</h2>
                <button class="profile-close" onclick="closeProfile()">×</button>
            </div>
            
            <div class="profile-body">
                <div class="profile-card">
                    <div class="profile-avatar">
                        <span class="avatar-emoji" id="profileAvatar">🎨</span>
                    </div>
                    <div class="profile-info">
                        <h3 id="profileUsername">Loading...</h3>
                        <div class="profile-level">
                            <span class="level-badge" id="profileLevel">Level 1</span>
                        </div>
                    </div>
                </div>
                
                <div class="profile-stats">
                    <div class="stat-card pixels-placed">
                        <div class="stat-icon">🎯</div>
                        <div class="stat-info">
                            <div class="stat-number" id="statPixelsPlaced">0</div>
                            <div class="stat-label">Pixels Placed</div>
                        </div>
                    </div>
                    
                    <div class="stat-card time-active">
                        <div class="stat-icon">⏰</div>
                        <div class="stat-info">
                            <div class="stat-number" id="statTimeActive">0h</div>
                            <div class="stat-label">Time Active</div>
                        </div>
                    </div>
                    
                    <div class="stat-card pixel-bag">
                        <div class="stat-icon">💰</div>
                        <div class="stat-info">
                            <div class="stat-number" id="statPixelBag">0/0</div>
                            <div class="stat-label">Pixel Bag</div>
                        </div>
                    </div>
                    
                    <div class="stat-card join-date">
                        <div class="stat-icon">📅</div>
                        <div class="stat-info">
                            <div class="stat-number" id="statJoinDate">Today</div>
                            <div class="stat-label">Joined</div>
                        </div>
                    </div>
                </div>
                
                <div class="profile-achievements">
                    <h4>🏆 Achievements</h4>
                    <div class="achievements-grid" id="achievementsGrid"><!-- populated dynamically --></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Achievement Toasts -->
    <div id="achievementToasts" style="position:fixed; top:20px; right:20px; z-index:12000; display:flex; flex-direction:column; gap:12px; pointer-events:none;"></div>

    <!-- Loot Boxes Modal -->
    <div class="loot-modal glass-readable" id="lootModal" style="display:none;">
        <div class="loot-modal-content">
            <div class="loot-header">
                <h2><span class="material-symbols-rounded icon-inline">inventory_2</span> Loot Boxes</h2>
                <button class="loot-close" onclick="closeLootBoxesModal()">×</button>
            </div>
            <div id="lootBoxesList" class="loot-boxes-list">Loading...</div>
            <div class="loot-result" id="lootResult" style="display:none;"></div>
        </div>
    </div>

    <!-- Rankings Modal -->
    <div class="rankings-modal glass-readable" id="rankingsModal">
        <div class="rankings-content">
            <div class="rankings-header">
                <h2><span class="material-symbols-rounded icon-inline">emoji_events</span> Global Rankings</h2>
                <button class="rankings-close" onclick="closeRankings()">×</button>
            </div>
            <div class="rankings-tabs">
                <button class="ranking-tab active" data-type="pixels" onclick="switchRankingTab(this,'pixels')">Pixels</button>
                <button class="ranking-tab" data-type="messages" onclick="switchRankingTab(this,'messages')">Messages</button>
                <button class="ranking-tab" data-type="level" onclick="switchRankingTab(this,'level')">Level</button>
                <button class="ranking-tab" data-type="achievements" onclick="switchRankingTab(this,'achievements')">Achievements</button>
            </div>
            <div class="rankings-table-wrapper">
                <table class="rankings-table" id="rankingsTable">
                    <thead>
                        <tr>
                            <th>Rank</th><th>User</th><th id="metricHeader">Pixels</th><th>Lvl</th><th>Achv</th>
                        </tr>
                    </thead>
                    <tbody id="rankingsBody"><tr><td colspan="5" style="text-align:center; opacity:.7;">Loading...</td></tr></tbody>
                </table>
            </div>
            <div class="rankings-footer">
                <span class="footnote" id="rankingFootnote"></span>
            </div>
        </div>
    </div>

    <!-- Admin Panel (Refactored) -->
    <div id="adminModal" class="admin-overlay" style="display:none;">
        <div class="floating-panel admin-panel" role="dialog" aria-modal="true" aria-labelledby="adminPanelTitle">
            <div class="panel-header admin-panel-header">
                <div class="panel-title" id="adminPanelTitle"><span class="material-symbols-rounded icon-inline">build</span> Administration</div>
                <div class="admin-header-actions">
                    <button class="btn btn-icon" onclick="closeAdminPanel()" title="Close" style="padding:8px 10px; min-width:auto;">
                        <span class="material-symbols-rounded">close</span>
                    </button>
                </div>
            </div>
            <div class="admin-body">
                <div class="admin-nav" role="tablist">
                    <button class="admin-tab active" data-target="usersTab" onclick="switchAdminSection(this)"><span class="material-symbols-rounded">group</span><span>Users</span></button>
                    <button class="admin-tab" data-target="statsTab" onclick="switchAdminSection(this)"><span class="material-symbols-rounded">analytics</span><span>Stats</span></button>
                    <button class="admin-tab" data-target="achievementsAdminTab" onclick="switchAdminSection(this)"><span class="material-symbols-rounded">emoji_events</span><span>Achievements</span></button>
                    <button class="admin-tab" data-target="lootAdminTab" onclick="switchAdminSection(this)"><span class="material-symbols-rounded">inventory_2</span><span>Loot</span></button>
                </div>
                <div class="admin-sections">
                    <!-- Users -->
                    <section id="usersTab" class="admin-section active" aria-label="Users Management">
                        <div class="section-toolbar">
                            <div class="toolbar-left">
                                <button class="btn" onclick="refreshUsers()"><span class="material-symbols-rounded">refresh</span>Refresh</button>
                                <div class="input-wrapper">
                                    <span class="material-symbols-rounded">search</span>
                                    <input type="text" id="userSearchInput" placeholder="Search users..." onkeyup="filterUsers()" />
                                </div>
                            </div>
                            <div class="toolbar-right" id="usersMeta"></div>
                        </div>
                        <div class="users-list" id="usersList"><div class="loading">Loading users...</div></div>
                        <div class="inline-hint" id="usersHint" style="display:none;">No users found.</div>
                    </section>
                    <!-- Stats -->
                    <section id="statsTab" class="admin-section" aria-label="Platform Stats">
                        <div class="stats-grid" id="statsGrid">
                            <div class="stat-card"><h3>Total Users</h3><div class="stat-value" id="totalUsers">-</div></div>
                            <div class="stat-card"><h3>Active Users</h3><div class="stat-value" id="activeUsers">-</div></div>
                            <div class="stat-card"><h3>Banned Users</h3><div class="stat-value" id="bannedUsers">-</div></div>
                            <div class="stat-card"><h3>Total Pixels Placed</h3><div class="stat-value" id="totalPixels">-</div></div>
                        </div>
                    </section>
                    <!-- Achievements -->
                    <section id="achievementsAdminTab" class="admin-section" aria-label="Achievement Definitions">
                        <div class="section-toolbar">
                            <div class="toolbar-left">
                                <button class="btn" onclick="refreshAchievementDefs()"><span class="material-symbols-rounded">refresh</span>Refresh</button>
                                <button class="btn" onclick="openNewAchievementForm()"><span class="material-symbols-rounded">add</span>New</button>
                                <button class="btn" onclick="exportAchievementDefs()"><span class="material-symbols-rounded">download</span>Export</button>
                                <label class="btn import-label" title="Import JSON"> <span class="material-symbols-rounded">upload</span>Import<input type="file" accept="application/json" onchange="importAchievementDefs(event)" hidden></label>
                            </div>
                            <div class="toolbar-right" id="achDefsMeta"></div>
                        </div>
                        <div id="achievementDefsList" class="ach-defs-list"></div>
                        <div id="achievementEditor" class="ach-editor" style="display:none;">
                            <h3 id="achEditorTitle">New Achievement</h3>
                            <div class="form-grid">
                                <label>ID<input id="achId" type="text" placeholder="unique_id"></label>
                                <label>Icon<input id="achIcon" type="text" placeholder="e.g. star" maxlength="32"></label>
                                <label>Name<input id="achName" type="text" placeholder="Visible name"></label>
                                <label>Tier
                                    <select id="achTier">
                                        <option value="">(none)</option>
                                        <option value="easy">Easy</option>
                                        <option value="normal">Normal</option>
                                        <option value="hard">Hard</option>
                                        <option value="epic">Epic</option>
                                        <option value="legendary">Legendary</option>
                                    </select>
                                </label>
                                <label>Desc<textarea id="achDesc" rows="2" placeholder="Description"></textarea></label>
                                <label>Condition<select id="achCondType"><option value="pixels">pixels</option><option value="bulk_uses">bulk_uses</option><option value="chat_messages">chat_messages</option><option value="session_minutes">session_minutes</option></select></label>
                                <label>Value<input id="achCondValue" type="number" min="1" value="1"></label>
                            </div>
                            <div class="ach-editor-actions">
                                <button class="btn btn-primary" onclick="saveAchievementDef()">Save</button>
                                <button class="btn" onclick="closeAchievementEditor()">Cancel</button>
                            </div>
                        </div>
                    </section>
                    <!-- Loot Management (integrated) -->
                    <section id="lootAdminTab" class="admin-section" aria-label="Loot Management">
                        <div class="section-toolbar">
                            <div class="toolbar-left">
                                <button class="btn" onclick="adminLoadItems()"><span class="material-symbols-rounded">refresh</span>Reload Items</button>
                                <button class="btn" onclick="adminLoadBoxes()"><span class="material-symbols-rounded">refresh</span>Reload Boxes</button>
                                <button class="btn" onclick="openLootEditor('item')"><span class="material-symbols-rounded">add</span>New Item</button>
                                <button class="btn" onclick="openLootEditor('box')"><span class="material-symbols-rounded">inventory_2</span>New Box</button>
                                <button class="btn" onclick="openTierEditor()"><span class="material-symbols-rounded">tune</span>Tiers</button>
                            </div>
                            <div class="toolbar-right" id="lootMeta"></div>
                        </div>
                        <div class="loot-admin-inner">
                            <div class="loot-subtabs">
                                <button class="loot-subtab active" data-target="adminItems" onclick="lootSubSwitch(this)">Items</button>
                                <button class="loot-subtab" data-target="adminBoxes" onclick="lootSubSwitch(this)">Boxes</button>
                                <button class="loot-subtab" data-target="adminImportExport" onclick="lootSubSwitch(this)">Import/Export</button>
                            </div>
                            <div class="loot-subpanes">
                                <div id="adminItems" class="loot-pane" style="display:block;">
                                    <h4>Items</h4>
                                    <p class="inline-hint">Use <strong>New Item</strong> ou Edit para gerenciar. Form antigo removido.</p>
                                    <div id="adminItemsList" class="admin-list"></div>
                                </div>
                                <div id="adminBoxes" class="loot-pane" style="display:none;">
                                    <h4>Boxes</h4>
                                    <p class="inline-hint">Use <strong>New Box</strong> ou Edit para gerenciar. Form antigo removido.</p>
                                    <div id="adminBoxesList" class="admin-list"></div>
                                </div>
                                <div id="adminImportExport" class="loot-pane" style="display:none;">
                                    <h4>Import / Export</h4>
                                    <div class="import-export">
                                        <button id="btnExportLoot" type="button">Export JSON</button>
                                        <textarea id="lootExportArea" placeholder="Export output" style="width:100%;height:120px;"></textarea>
                                        <textarea id="lootImportArea" placeholder='{"items":[],"boxes":[]}' style="width:100%;height:120px;"></textarea>
                                        <button id="btnImportLoot" type="button">Import</button>
                                        <div id="lootImportStatus" class="status-line"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </div>
        <!-- Ban Modal (global overlay inside admin) -->
        <div class="ban-modal" id="banModal" style="display:none;">
            <div class="ban-modal-content">
                <h3>Ban User</h3>
                <form id="banForm" onsubmit="handleBanUser(event)">
                    <input type="hidden" id="banUsername" name="banUsername">
                    <div class="form-group">
                        <label>Reason:</label>
                        <input type="text" id="banReason" name="banReason" placeholder="Reason for ban" required>
                    </div>
                    <div class="form-group">
                        <label><input type="checkbox" id="banTemporary" name="banTemporary"> Temporary ban (24h)</label>
                    </div>
                    <div class="ban-actions">
                        <button type="submit" class="btn btn-danger">Ban User</button>
                        <button type="button" onclick="closeBanModal()" class="btn">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="/static/js/app.js"></script>
    <!-- Dynamic Item/Box Editor Modal -->
    <div id="lootEditorModal" class="glass-readable loot-editor-modal" style="display:none;">
        <div class="loot-editor-content">
            <div class="loot-editor-header">
                <h3 id="lootEditorTitle">New Item</h3>
                <button onclick="closeLootEditor()" class="btn btn-icon"><span class="material-symbols-rounded">close</span></button>
            </div>
            <div class="loot-editor-body">
                <div class="editor-left">
                    <form id="lootEditorForm">
                        <input type="hidden" name="mode" value="item" id="lootEditorMode">
                        <div class="form-grid">
                            <div class="field"><label for="loot-id">ID</label><input id="loot-id" name="id" required placeholder="unique_id" autocomplete="off"></div>
                            <div class="field"><label for="loot-name">Name</label><input id="loot-name" name="name" required placeholder="Display name" autocomplete="off"></div>
                            <div class="field" id="fieldTypeWrapper"><label for="lootTypeSelect">Type</label><select name="type" id="lootTypeSelect" onchange="lootEditorTypeChanged()"><option value="color">Color</option><option value="effect">Effect</option><option value="upgrade">Upgrade</option><option value="currency_pack">Currency Pack</option></select></div>
                            <div class="field"><label for="lootRaritySelect">Rarity</label><select name="rarity" id="lootRaritySelect"></select></div>
                        </div>
                        <div class="conditional-group">
                            <div class="field conditional field-color" style="display:none;"><label for="loot-color">Color</label><input id="loot-color" name="payload.color" type="text" placeholder="#ff00ff" oninput="updateLootPreview()"></div>
                            <div class="field conditional field-effect" style="display:none;"><label for="loot-effect">Effect</label><select id="loot-effect" name="payload.effect" onchange="updateLootPreview()"><option value="">(none)</option><option value="glow">Glow</option><option value="spark">Spark</option></select></div>
                            <div class="field conditional field-upgrade" style="display:none;"><label for="loot-upgrade-delta">Bag +</label><input id="loot-upgrade-delta" name="payload.max_pixel_bag_delta" type="number" min="1" step="1" value="5" oninput="updateLootPreview()"></div>
                            <div class="field conditional field-currency_pack" style="display:none;"><label for="loot-coins">Coins</label><input id="loot-coins" name="payload.coins" type="number" min="1" step="1" value="100" oninput="updateLootPreview()"></div>
                        </div>
                        <div class="box-section box-only" style="display:none;">
                            <h4 class="section-title">Box Settings</h4>
                            <div class="form-grid box-grid">
                                <div class="field"><label for="loot-price">Price (coins)</label><input id="loot-price" name="price_coins" type="number" min="0" value="0"></div>
                                <div class="field"><label for="loot-max-rolls">Max Rolls</label><input id="loot-max-rolls" name="max_rolls" type="number" min="1" value="1"></div>
                                <div class="field"><label for="loot-guaranteed">Guaranteed IDs</label><textarea id="loot-guaranteed" name="guaranteed" rows="2" placeholder="id1,id2"></textarea></div>
                                <div class="field full-span"><label for="loot-rarity-bonus">Rarity Bonus JSON</label><textarea id="loot-rarity-bonus" name="rarity_bonus" rows="2" placeholder='{"rare":5}'></textarea></div>
                            </div>
                            <div class="drops-wrapper">
                                <div class="drops-header">
                                    <h5>Drops</h5>
                                    <div class="drops-tools"><button type="button" class="btn small" onclick="addDropRow()" aria-label="Add drop"><span class="material-symbols-rounded">add</span></button></div>
                                </div>
                                <div class="drops-table" role="table" aria-label="Loot box drops">
                                    <div class="drops-thead" role="rowgroup">
                                        <div class="drops-row drops-head" role="row">
                                            <div class="cell" role="columnheader">Item</div>
                                            <div class="cell small" role="columnheader">Weight</div>
                                            <div class="cell small" role="columnheader">%</div>
                                            <div class="cell action" role="columnheader">Del</div>
                                        </div>
                                    </div>
                                    <div class="drop-rows" id="dropRows" role="rowgroup"></div>
                                </div>
                                <p class="hint">Weights são relativos; % calculada automaticamente.</p>
                            </div>
                        </div>
                        <div class="field"><label for="loot-tags">Tags</label><input id="loot-tags" name="tags" type="text" placeholder="tag1, tag2" oninput="updateLootPreview()"></div>
                        <div class="editor-actions">
                            <button type="button" class="btn" onclick="switchLootEditorMode()" id="switchModeBtn">Switch to Box</button>
                            <button type="button" class="btn btn-primary" id="saveLootBtn" onclick="saveLootEditor()">Save</button>
                        </div>
                    </form>
                </div>
                <div class="editor-preview" id="lootEditorPreview">
                    <h4>Preview</h4>
                    <div class="preview-card" id="lootPreviewCard"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tier Editor Modal -->
    <div id="tierEditorModal" class="glass-readable tier-editor-modal" style="display:none;">
        <div class="tier-editor-content">
            <div class="tier-editor-header">
                <h3>Item Tiers</h3>
                <button onclick="closeTierEditor()" class="btn btn-icon"><span class="material-symbols-rounded">close</span></button>
            </div>
            <div class="tier-editor-body">
                <table class="tier-table" id="tierTable"><thead><tr><th>Rarity</th><th>Label</th><th>Color</th><th>Weight</th><th>Actions</th></tr></thead><tbody></tbody></table>
                <div class="tier-actions">
                    <button class="btn" type="button" onclick="addTier()"><span class="material-symbols-rounded" style="vertical-align:middle;font-size:18px;">add</span> Add Tier</button>
                    <button class="btn btn-primary" onclick="saveTierConfig()">Save</button>
                </div>
            </div>
        </div>
    </div>
</body>

</html>